# actionlint: allow-secrets ADMIN_TOKEN
name: admin-branch-protection

on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why the protection update is requested
        required: false
        default: manual
  push:
    branches:
      - main
    paths:
      - .github/workflows/admin-branch-protection.yml

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Configure branch protection on main
        uses: actions/github-script@d7906e5d00cf2c947a3359557e09b31135f6c4da
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            if (!github.token) {
              core.setFailed('ADMIN_TOKEN secret is not configured');
              return;
            }

            await github.request('PUT /repos/{owner}/{repo}/branches/{branch}/protection', {
              owner,
              repo,
              branch: 'main',
              required_status_checks: {
                strict: true,
                checks: [
                  { context: 'lint' },
                  { context: 'm0-determinism' },
                  { context: 'verify-strict' },
                  { context: 'dataqa-tolerance' },
                  { context: 'nightly-canary' }
                ]
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                dismissal_restrictions: {},
                dismiss_stale_reviews: true,
                require_code_owner_reviews: false,
                required_approving_review_count: 1,
                require_last_push_approval: false,
                bypass_pull_request_allowances: {}
              },
              restrictions: null,
              required_linear_history: false,
              allow_force_pushes: false,
              allow_deletions: false,
              block_creations: false,
              required_conversation_resolution: false,
              lock_branch: false,
              allow_fork_syncing: true
            });

            core.info('Branch protection updated successfully.');

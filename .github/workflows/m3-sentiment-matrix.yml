name: m3-sentiment-matrix

on:
  push:
    branches: [ main, feat/m3-active ]
  pull_request:
    branches: [ main, feat/m3-active ]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      sim_path: ${{ steps.locate.outputs.sim_path }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore
        run: dotnet restore
      - name: Build Release (all)
        run: dotnet build -c Release --no-restore
      - name: Build Tools (explicit)
        run: dotnet build src/TiYf.Engine.Tools/TiYf.Engine.Tools.csproj -c Release --no-restore --nologo
      - name: Guard Tools Release DLL
        run: |
          set -euo pipefail
          TOOLS=src/TiYf.Engine.Tools/bin/Release/net8.0/TiYf.Engine.Tools.dll
          if [ ! -f "$TOOLS" ]; then
            echo "ERROR: Expected Tools DLL at $TOOLS after Release build" >&2
            ls -R src/TiYf.Engine.Tools/bin || true
            exit 1
          fi
      - name: Run Tests
        run: dotnet test -c Release --no-build --no-restore
      - name: Clean Working Tree (no diffs / untracked) # strict guard
        run: |
          set -euo pipefail
          git diff --exit-code
          test $(git ls-files --others --exclude-standard | wc -l) -eq 0
      - name: Locate Sim Binary
        id: locate
        run: |
          echo "sim_path=src/TiYf.Engine.Sim/bin/Release/net8.0/TiYf.Engine.Sim.dll" >> $GITHUB_OUTPUT
      - name: Archive Release Binaries
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: |
            src/**/bin/Release/net8.0/*.dll
            src/**/bin/Release/net8.0/*.exe
            src/**/bin/Release/net8.0/*.runtimeconfig.json
            src/**/bin/Release/net8.0/*.deps.json

  sentiment:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mode: [off, shadow, active]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Download Release Binaries
        uses: actions/download-artifact@v4
        with:
          name: release-binaries
      - name: Prepare Config & Run (${{ matrix.mode }})
        env:
          MODE: ${{ matrix.mode }}
        run: |
          set -euo pipefail
          echo "Listing artifact root (first 200 entries)"; find . -maxdepth 6 -type f | head -n 200
          CFG=tests/fixtures/backtest_m0/config.backtest-m0.candidate.json
          TEMP_CFG=$(mktemp /tmp/sentiment-XXXX.json)
          if ! command -v jq >/dev/null; then sudo apt-get update && sudo apt-get install -y jq; fi
          if [ "$MODE" = "active" ]; then
            jq '.featureFlags.sentiment="active" | .featureFlags.riskProbe="disabled" | .sentimentConfig={"window":5,"volGuardSigma":1e-7}' "$CFG" > "$TEMP_CFG"
          elif [ "$MODE" = "shadow" ]; then
            jq '.featureFlags.sentiment="shadow" | .featureFlags.riskProbe="disabled" | .sentimentConfig={"window":5,"volGuardSigma":1e-7}' "$CFG" > "$TEMP_CFG"
          else
            jq '.featureFlags.sentiment="off" | .featureFlags.riskProbe="disabled"' "$CFG" > "$TEMP_CFG"
          fi
          # Prefer canonical path; if not found, search artifact.
          SIM_CANON=src/TiYf.Engine.Sim/bin/Release/net8.0/TiYf.Engine.Sim.dll
          if [ -f "$SIM_CANON" ]; then SIM_DLL="$SIM_CANON"; else SIM_DLL=$(find . -name TiYf.Engine.Sim.dll | head -n1 || true); fi
          if [ -z "$SIM_DLL" ]; then
             echo "ERROR: TiYf.Engine.Sim.dll not found in artifact or expected path" >&2
             echo "Debug listing around expected directories:" >&2
             find . -maxdepth 6 -type d -path '*TiYf.Engine.Sim*' -print >&2 || true
             exit 1
          fi
          echo "Using SIM DLL: $SIM_DLL"
          dotnet exec "$SIM_DLL" --config "$TEMP_CFG" --run-id CI-$MODE --quiet
          mkdir -p artifacts/$MODE
          cp -r journals/M0/*CI-$MODE* artifacts/$MODE/ || true
      - name: Upload journals (${{ matrix.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: journals-${{ matrix.mode }}
          path: artifacts/${{ matrix.mode }}
      - name: Working Tree Cleanliness (strict)
        run: |
          set -euo pipefail
          git diff --exit-code
          test $(git ls-files --others --exclude-standard | wc -l) -eq 0

  invariants:
    runs-on: ubuntu-latest
    needs: sentiment
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Validate Cross-Mode Invariants
        run: |
          set -euo pipefail
          ROOT=journals/M0
          OFF_EVENTS=$(ls $ROOT/*CI-off*/events.csv)
          SHADOW_EVENTS=$(ls $ROOT/*CI-shadow*/events.csv)
          ACTIVE_EVENTS=$(ls $ROOT/*CI-active*/events.csv)
          OFF_TRADES=$(ls $ROOT/*CI-off*/trades.csv)
          SHADOW_TRADES=$(ls $ROOT/*CI-shadow*/trades.csv)
          ACTIVE_TRADES=$(ls $ROOT/*CI-active*/trades.csv)
          hash_skip_meta(){ tail -n +2 "$1" | sha256sum | cut -d' ' -f1; }
          if [ "$(hash_skip_meta "$OFF_TRADES")" != "$(hash_skip_meta "$SHADOW_TRADES")" ]; then echo 'ERROR: off vs shadow trades mismatch'; exit 1; fi
          if grep -q INFO_SENTIMENT_Z_V1 "$OFF_EVENTS"; then echo 'ERROR: off mode has Z events'; exit 1; fi
          if ! grep -q INFO_SENTIMENT_Z_V1 "$SHADOW_EVENTS"; then echo 'ERROR: shadow missing Z events'; exit 1; fi
          if grep -q INFO_SENTIMENT_APPLIED_V1 "$ACTIVE_EVENTS"; then
            if diff <(tail -n +3 "$ACTIVE_EVENTS") <(tail -n +3 "$SHADOW_EVENTS") >/dev/null; then echo 'ERROR: expected divergence after clamp'; exit 1; fi
          fi
      - name: Upload All Journals (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: journals-all
          path: journals/M0

name: daily-monitor

on:
  schedule:
    - cron: '15 2 * * 1-5'
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

concurrency:
  group: daily-monitor-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor-health:
    runs-on: [self-hosted, Linux, X64, tiyf-vps]
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    env:
      HEALTH_PATH: scratch/health.json
      RUNNER_LABELS: "self-hosted, Linux, X64, tiyf-vps"
    steps:
      - name: Install PowerShell 7
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          POWERSHELL_VERSION="7.4.6"
          INSTALL_ROOT="$HOME/powershell"

          if [ -x "$INSTALL_ROOT/pwsh" ]; then
            echo "$INSTALL_ROOT" >> "$GITHUB_PATH"
            exit 0
          fi

          if [ -x "$INSTALL_ROOT/powershell-${POWERSHELL_VERSION}-linux-x64/pwsh" ]; then
            echo "$INSTALL_ROOT/powershell-${POWERSHELL_VERSION}-linux-x64" >> "$GITHUB_PATH"
            exit 0
          fi

          mkdir -p "$INSTALL_ROOT"
          curl -fSLo powershell.tar.gz "https://github.com/PowerShell/PowerShell/releases/download/v${POWERSHELL_VERSION}/powershell-${POWERSHELL_VERSION}-linux-x64.tar.gz"
          curl -fSLo checksums.txt "https://github.com/PowerShell/PowerShell/releases/download/v${POWERSHELL_VERSION}/SHA256SUMS"
          EXPECTED_SUM="$(grep "powershell-${POWERSHELL_VERSION}-linux-x64.tar.gz" checksums.txt | awk '{print $1}')"
          if [ -z "$EXPECTED_SUM" ]; then
            echo "ERROR: Unable to locate expected checksum for PowerShell archive" >&2
            exit 1
          fi
          ACTUAL_SUM="$(sha256sum powershell.tar.gz | awk '{print $1}')"
          if [ "$EXPECTED_SUM" != "$ACTUAL_SUM" ]; then
            echo "ERROR: Checksum verification failed for powershell.tar.gz" >&2
            echo "Expected: $EXPECTED_SUM" >&2
            echo "Actual:   $ACTUAL_SUM" >&2
            exit 1
          fi
          tar -xzf powershell.tar.gz -C "$INSTALL_ROOT"
          rm powershell.tar.gz checksums.txt

          if [ -x "$INSTALL_ROOT/pwsh" ]; then
            chmod +x "$INSTALL_ROOT/pwsh"
            echo "$INSTALL_ROOT" >> "$GITHUB_PATH"
          elif [ -x "$INSTALL_ROOT/powershell-${POWERSHELL_VERSION}-linux-x64/pwsh" ]; then
            chmod +x "$INSTALL_ROOT/powershell-${POWERSHELL_VERSION}-linux-x64/pwsh"
            echo "$INSTALL_ROOT/powershell-${POWERSHELL_VERSION}-linux-x64" >> "$GITHUB_PATH"
          else
            echo "Failed to locate pwsh after extraction" >&2
            find "$INSTALL_ROOT" -maxdepth 3 -type f -name 'pwsh' -print || true
            exit 1
          fi

      - name: Prepare workspace
        run: |
          set -euo pipefail
          rm -rf scratch
          mkdir -p scratch

      - name: Report runner context
        shell: pwsh
        run: |
          Write-Host ("Runner name: {0}" -f $env:RUNNER_NAME)
          Write-Host ("Runner labels: {0}" -f $env:RUNNER_LABELS)

      - name: Fetch /health snapshot
        run: |
          set -euo pipefail
          attempts=0
          while [ $attempts -lt 5 ]; do
            if curl -fsS http://127.0.0.1:8080/health -o "$HEALTH_PATH"; then
              break
            fi
            attempts=$((attempts + 1))
            sleep 2
          done

          if [ ! -s "$HEALTH_PATH" ]; then
            echo "Failed to capture /health after $attempts attempts" >&2
            exit 1
          fi

      - name: Log disk usage
        run: |
          set -euo pipefail
          df -h

      - name: Validate health payload
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $path = $env:HEALTH_PATH
          if (-not (Test-Path -Path $path)) {
            throw "/health payload missing at $path"
          }

          $health = Get-Content -Raw -Path $path | ConvertFrom-Json
          if ($null -eq $health) {
            throw "Unable to parse JSON from $path"
          }
          $adapter = $health.adapter
          $connected = [bool]$health.connected
          $heartbeat = $health.last_heartbeat_utc
          $heartbeatIso = if ($health.PSObject.Properties.Name -contains 'last_heartbeat_utc' -and $null -ne $health.last_heartbeat_utc) {
            ([DateTime]$health.last_heartbeat_utc).ToString('o', [System.Globalization.CultureInfo]::InvariantCulture)
          } else {
            ''
          }
          $heartbeatAge = if ($health.PSObject.Properties.Name -contains 'heartbeat_age_seconds') { [double]$health.heartbeat_age_seconds } else { 0 }
          $barLag = if ($health.PSObject.Properties.Name -contains 'bar_lag_ms') { [double]$health.bar_lag_ms } else { 0 }
          $openPositions = if ($health.PSObject.Properties.Name -contains 'open_positions') { [int]$health.open_positions } else { 0 }
          $activeOrders = if ($health.PSObject.Properties.Name -contains 'active_orders') { [int]$health.active_orders } else { 0 }
          $riskEventsTotal = if ($health.PSObject.Properties.Name -contains 'risk_events_total') { [int64]$health.risk_events_total } else { 0 }
          $alertsTotal = if ($health.PSObject.Properties.Name -contains 'alerts_total') { [int64]$health.alerts_total } else { 0 }
          $riskConfigHash = if ($health.PSObject.Properties.Name -contains 'risk_config_hash') { [string]$health.risk_config_hash } else { '' }
          $riskBlocksTotal = if ($health.PSObject.Properties.Name -contains 'risk_blocks_total') { [int64]$health.risk_blocks_total } else { 0 }
          $riskThrottlesTotal = if ($health.PSObject.Properties.Name -contains 'risk_throttles_total') { [int64]$health.risk_throttles_total } else { 0 }
          $streamConnected = if ($health.PSObject.Properties.Name -contains 'stream_connected') { [int]$health.stream_connected } else { 0 }
          $streamHeartbeatAge = if ($health.PSObject.Properties.Name -contains 'stream_heartbeat_age_seconds') { [double]$health.stream_heartbeat_age_seconds } else { 0 }
          $lastDecisionUtc = if ($health.PSObject.Properties.Name -contains 'last_decision_utc' -and $null -ne $health.last_decision_utc) { [string]$health.last_decision_utc } else { '' }
          $lastDecisionIso = if ($health.PSObject.Properties.Name -contains 'last_decision_utc' -and $null -ne $health.last_decision_utc) {
            ([DateTime]$health.last_decision_utc).ToString('o', [System.Globalization.CultureInfo]::InvariantCulture)
          } else {
            ''
          }
          $timeframesActive = if ($health.PSObject.Properties.Name -contains 'timeframes_active') { ($health.timeframes_active | ForEach-Object { $_.ToString() }) -join ',' } else { '' }
          $decisionsTotal = if ($health.PSObject.Properties.Name -contains 'decisions_total') { [int64]$health.decisions_total } else { 0 }
          $loopIterationsTotal = if ($health.PSObject.Properties.Name -contains 'loop_iterations_total') { [int64]$health.loop_iterations_total } else { 0 }

          if (-not $connected) {
            throw "Expected connected=true but found connected=$connected"
          }

          "DAILY_MONITOR_ADAPTER=$adapter" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_CONNECTED=$connected" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_HEARTBEAT=$heartbeat" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_HEARTBEAT_ISO=$heartbeatIso" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_HEARTBEAT_AGE=$heartbeatAge" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_BAR_LAG_MS=$barLag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_OPEN_POSITIONS=$openPositions" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_ACTIVE_ORDERS=$activeOrders" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_RISK_EVENTS_TOTAL=$riskEventsTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_ALERTS_TOTAL=$alertsTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_RISK_CONFIG_HASH=$riskConfigHash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_RISK_BLOCKS_TOTAL=$riskBlocksTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_RISK_THROTTLES_TOTAL=$riskThrottlesTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_STREAM_CONNECTED=$streamConnected" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_STREAM_HEARTBEAT_AGE=$streamHeartbeatAge" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_LAST_DECISION=$lastDecisionUtc" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_LAST_DECISION_ISO=$lastDecisionIso" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_TIMEFRAMES=$timeframesActive" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_DECISIONS_TOTAL=$decisionsTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "DAILY_MONITOR_LOOP_ITERATIONS=$loopIterationsTotal" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload health artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-monitor-health
          path: |
            ${{ env.HEALTH_PATH }}

      - name: Summarize verdict
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $adapter = $env:DAILY_MONITOR_ADAPTER
          $connected = $env:DAILY_MONITOR_CONNECTED
          $heartbeat = $env:DAILY_MONITOR_HEARTBEAT
          $heartbeatIso = if ([string]::IsNullOrWhiteSpace($env:DAILY_MONITOR_HEARTBEAT_ISO)) { 'n/a' } else { $env:DAILY_MONITOR_HEARTBEAT_ISO }
          $heartbeatAge = [double]::Parse(($env:DAILY_MONITOR_HEARTBEAT_AGE ?? '0'), [System.Globalization.CultureInfo]::InvariantCulture)
          $barLag = [double]::Parse(($env:DAILY_MONITOR_BAR_LAG_MS ?? '0'), [System.Globalization.CultureInfo]::InvariantCulture)
          $openPositions = $env:DAILY_MONITOR_OPEN_POSITIONS
          $activeOrders = $env:DAILY_MONITOR_ACTIVE_ORDERS
          $riskEvents = $env:DAILY_MONITOR_RISK_EVENTS_TOTAL
          $alertsTotal = $env:DAILY_MONITOR_ALERTS_TOTAL
          $streamConnected = $env:DAILY_MONITOR_STREAM_CONNECTED
          $streamHeartbeatAge = [double]::Parse(($env:DAILY_MONITOR_STREAM_HEARTBEAT_AGE ?? '0'), [System.Globalization.CultureInfo]::InvariantCulture)
          $lastDecisionIso = if ([string]::IsNullOrWhiteSpace($env:DAILY_MONITOR_LAST_DECISION_ISO)) { 'none' } else { $env:DAILY_MONITOR_LAST_DECISION_ISO }
          $timeframes = if ([string]::IsNullOrWhiteSpace($env:DAILY_MONITOR_TIMEFRAMES)) { 'n/a' } else { $env:DAILY_MONITOR_TIMEFRAMES }
          $decisionsTotal = $env:DAILY_MONITOR_DECISIONS_TOTAL
          $loopIterations = $env:DAILY_MONITOR_LOOP_ITERATIONS
          $riskConfigHash = if ([string]::IsNullOrWhiteSpace($env:DAILY_MONITOR_RISK_CONFIG_HASH)) { 'n/a' } else { $env:DAILY_MONITOR_RISK_CONFIG_HASH }
          $riskBlocksTotal = $env:DAILY_MONITOR_RISK_BLOCKS_TOTAL
          $riskThrottlesTotal = $env:DAILY_MONITOR_RISK_THROTTLES_TOTAL
          $heartbeatFormatted = ('{0:0.0}' -f $heartbeatAge)
          $streamHeartbeatFormatted = ('{0:0.0}' -f $streamHeartbeatAge)
          $barLagString = $barLag.ToString([System.Globalization.CultureInfo]::InvariantCulture)
          $line = "daily-monitor: adapter={0} connected={1} last_heartbeat_utc={2} heartbeat_age={3}s stream_connected={4} stream_heartbeat_age={5}s bar_lag_ms={6} open_positions={7} active_orders={8} risk_events_total={9} alerts_total={10} last_decision_utc={11} timeframes_active={12} decisions_total={13} loop_iterations_total={14} risk_config_hash={15} risk_blocks_total={16} risk_throttles_total={17}" -f $adapter, $connected, $heartbeatIso, $heartbeatFormatted, $streamConnected, $streamHeartbeatFormatted, $barLagString, $openPositions, $activeOrders, $riskEvents, $alertsTotal, $lastDecisionIso, $timeframes, $decisionsTotal, $loopIterations, $riskConfigHash, $riskBlocksTotal, $riskThrottlesTotal
          Write-Host $line
          Set-Content -Path (Join-Path 'scratch' 'summary.txt') -Value $line -Encoding UTF8
          Add-Content -Encoding UTF8 -Path $env:GITHUB_STEP_SUMMARY -Value "## daily-monitor verdict"
          Add-Content -Encoding UTF8 -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Encoding UTF8 -Path $env:GITHUB_STEP_SUMMARY -Value $line

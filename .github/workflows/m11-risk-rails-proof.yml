name: m11-risk-rails-proof

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/m11-risk-rails-proof.yml'
      - 'tools/RiskRailsProbe/**'
      - 'proof/m11-risk-config.json'
      - 'proof/m11-risk-config-live.json'
      - 'proof/m11-broker-cap-config.json'
      - 'docs/M11-Risk-Rails-Plan.md'
      - 'src/TiYf.Engine.Core/**'
      - 'src/TiYf.Engine.Host/**'
      - 'src/TiYf.Engine.Sim/**'

jobs:
  proof:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    concurrency:
      group: m11-risk-rails-proof-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Compute safe ref name
        id: vars
        run: |
          set -euo pipefail
          safe_ref="${GITHUB_REF_NAME//\//-}"
          echo "safe_ref=$safe_ref" >> "$GITHUB_OUTPUT"

      - name: Configure .NET install dir
        uses: ./.github/actions/configure-dotnet

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.416'
          cache: false

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run risk rails proof (telemetry)
        run: |
          set -euo pipefail
          out="proof-artifacts/m11-risk-rails"
          mkdir -p "$out/telemetry" "$out/live" "$out/broker"
          probe_proj="tools/RiskRailsProbe/RiskRailsProbe.csproj"
          probe="dotnet run --project ${probe_proj}"
          probe="$probe --configuration Release --"
          $probe --config proof/m11-risk-config.json \
            --output "$out/telemetry"
          $probe --config proof/m11-risk-config-live.json \
            --output "$out/live"
          $probe --config proof/m11-broker-cap-config.json \
            --output "$out/broker"

      - name: Verify proof artifacts (telemetry)
        run: |
          set -euo pipefail
          tele_dir="proof-artifacts/m11-risk-rails/telemetry"
          tele_metrics="$tele_dir/metrics.txt"
          tele_health="$tele_dir/health.json"
          ls "$tele_dir"
          grep -F "risk_rails_summary" "$tele_dir/summary.txt"
          grep -F "engine_risk_broker_daily_loss_used_ccy" "$tele_metrics"
          grep -F "engine_risk_max_position_units_used" "$tele_metrics"
          grep -F "engine_risk_symbol_unit_cap_violations_total" "$tele_metrics"
          grep -F "engine_risk_cooldown_triggers_total" "$tele_metrics"
          export TELE_HEALTH="$tele_health"
          python3 - <<'PY'
          import json, os
          data = json.load(open(os.environ["TELE_HEALTH"]))
          if 'risk_rails' not in data:
              raise SystemExit('missing risk_rails health block')
          rails = data['risk_rails']
          if not rails.get('cooldown', {}).get('enabled'):
              raise SystemExit('cooldown not enabled in health payload')
          PY

      - name: Verify proof artifacts (live)
        run: |
          set -euo pipefail
          live_dir="proof-artifacts/m11-risk-rails/live"
          live_metrics="$live_dir/metrics.txt"
          ls "$live_dir"
          grep -F "hard_blocks=" "$live_dir/summary.txt"
          grep -F "engine_risk_blocks_total" "$live_metrics"
          grep -F "ALERT_RISK_" "$live_dir/events.csv"
          value=$(awk '/^engine_risk_blocks_total[ {]/{print $NF; exit}' \
            "$live_metrics")
          if [ -z "$value" ] || [ "$value" -lt 1 ]; then
            echo "expected engine_risk_blocks_total >= 1, got '${value:-empty}'"
            exit 1
          fi

      - name: Verify proof artifacts (broker caps)
        run: |
          set -euo pipefail
          broker_dir="proof-artifacts/m11-risk-rails/broker"
          broker_metrics="$broker_dir/metrics.txt"
          broker_health="$broker_dir/health.json"
          ls "$broker_dir"
          grep -F "broker_cap_blocks=" "$broker_dir/summary.txt"
          grep -F "ALERT_RISK_BROKER_CAP_HARD" "$broker_dir/events.csv"
          grep -F "engine_broker_cap_blocks_total" "$broker_metrics"
          export BROKER_HEALTH="$broker_health"
          python3 - <<'PY'
          import json, os
          data = json.load(open(os.environ["BROKER_HEALTH"]))
          rails = data.get('risk_rails', {})
          blocks_total = rails.get('broker_cap_blocks_total')
          if blocks_total is None or blocks_total < 1:
              raise SystemExit(f"bad broker_cap_blocks_total: {blocks_total}")
          PY

      - name: Upload proof artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: m11-risk-rails-proof-${{ steps.vars.outputs.safe_ref }}
          path: proof-artifacts/m11-risk-rails
